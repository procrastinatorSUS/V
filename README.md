# Telegram bot для монетизации VLESS (3x-ui)

Асинхронный бот на `aiogram 3` для продажи доступа к VPN (VLESS через 3x-ui):
- разделение на **админ** и **пользовательский** сценарий;
- оплата: подписка/разовые планы;
- скидки на длинные сроки;
- выдача ключа через API панели;
- напоминание за 3 дня до окончания;
- логирование клиентов и платежей в PostgreSQL.

## Состояния/сценарий бота

### Пользователь
1. `/start` → регистрация в таблице `users`.
2. Выбор тарифа (`1 мес`, `1 год`, `3 мес`, `6 мес`).
3. Инвойс Telegram Payments.
4. После подтверждения оплаты:
   - фиксация платежа в `payments`;
   - выпуск ключа в 3x-ui;
   - запись подписки в `subscriptions`.
5. Раздел `Мой ключ` показывает текущий доступ и дату окончания.

### Админ
- Кнопка `Админ-панель` доступна только `ADMIN_IDS`.
- Показ базовой аналитики: число пользователей и выручка.

## Безопасность

1. **Ключи не хранятся открыто**: `access_key_encrypted` шифруется через Fernet.
2. Секреты только через `.env`, не в коде.
3. Рекомендуется запуск behind reverse proxy + HTTPS.
4. У Telegram-провайдера проверять id транзакций и id пользователя.
5. Ограничить доступ к 3x-ui API по firewall (только IP с ботом).
6. Подключить fail2ban, ufw, регулярные security updates Ubuntu 24.
7. Для прод: включить ротацию логов и masking PII.

## Быстрый запуск

```bash
python -m venv .venv
source .venv/bin/activate
pip install -e .[dev]
cp .env.example .env
python -m app.main
```

## Переменные окружения

См. `.env.example`.

## Платежные модели

- `monthly`: базовая цена `BASE_MONTHLY_PRICE`.
- `yearly`: 12 месяцев с `YEARLY_DISCOUNT_PERCENT`.
- `onetime_3`: 3 месяца со скидкой 5%.
- `onetime_6`: 6 месяцев со скидкой 10%.

## База данных

Структура в `db_schema.sql`.

## Что улучшить перед production

- Добавить webhook-режим вместо polling.
- Добавить реферальную систему и промокоды.
- Добавить отдельную таблицу `audit_logs`.
- Подключить Sentry/Prometheus/Grafana.
- Написать интеграционные тесты на оплату и 3x-ui API.
